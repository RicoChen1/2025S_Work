# transf.py 文本生成器

> **作用**：将维护团队提供的 **Excel/CSV 命令语法表** ➜ **TextFSM 模板集合**，为后续 CLI‑to‑JSON 解析链奠定基础。

---

## 目录

1. [整体流程](#整体流程)
2. [快速开始](#快速开始)
3. [核心设计要点](#核心设计要点)
4. [常见调试场景](#常见调试场景)
5. [后续改进指引](#后续改进指引)
6. [版本历史](#版本历史)

---

## 整体流程
```
┌──────────────┐      ┌──────────────┐      ┌────────────────┐
│ 命令树‑G.xlsx │ ──▶ │  transf.py   │ ──▶ │ *.template 文件 │
└──────────────┘      └──────────────┘      └────────────────┘
      ▲                         │                 │
      │                         │                 ▼
      │                         │        (下游) cmd_parser.py
      │                         │                 │
      │                         └── syntax.txt（可选）
      │                                    ▲
      └───────── 人类审阅 / Git Diff ──────┘
```
1. **读取**   Excel/CSV → DataFrame（pandas/openpyxl）。
2. **净化**   过滤中文、消除换行、展开 *bind/unbind* 等复合 verb。
3. **编译**   将 `<var>、{A\|B}、[opt]、...` 转为 TextFSM 正则。
4. **输出**   默认写入 `./templates/*.template`；附带简易语法清单。

---

## 快速开始
```bash
# 1) 生成模板 + 语法清单
python transf.py 命令树-G.xlsx --syntax-file syntax.txt

# 2) 仅预览，不落盘模板
python transf.py 命令树-G.xlsx --no-template

# 3) 指定模板目录
python transf.py 命令树-G.xlsx --templates-dir out_tpl
```
生成后，可用 [textfsm CLI](https://github.com/google/textfsm) 或 `ntc_templates` 的 `clitable` 快速验证匹配效果。

---

## 核心设计要点
| 主题                 | 说明 |
|----------------------|------|
| **单行 CLI 假设**     | Excel 内任何换行符均替换为空格，保持与真实设备一致。 |
| **中文行过滤**        | 避免注释/说明被误编译。 |
| **斜杠动词拆分**     | `bind/unbind` ➜ `bind` & `unbind` 两条模板。 |
| **省略号 `...` 支持** | 视为通配符 `.*`，允许可变长度参数列表。 |
| **文件名净化**        | 非 `[0‑9A‑Z_a‑z]` 字符替换为 `_`，兼容 Win/Linux。 |
| **零依赖 TextFSM**   | 生成阶段仅用 `pandas + openpyxl`；解析阶段才需 `textfsm`。 |

---

## 常见调试场景
| 场景 | 排查建议 |
|------|----------|
| **模板匹配失败** | ‑ 在 `syntax.txt` 搜索对应命令，确认正则是否包含期望关键字。<br>‑ 用 `python -m textfsm` 手动加载模板 + 测试样例。 |
| **生成文件缺失** | Excel 行被过滤：检查是否含中文 / verb 列空 / 首列是 `show`。 |
| **FileNotFoundError** | 通常由 verb 含非法文件字符导致；v0.4 起已通过 `FNAME_SAFE` 自动规避。 |
| **模板过多过少** | 对比 `syntax.txt` 与 Excel 行数；留意 `/` 拆分是否生效。 |

---

## 后续改进指引
1. **扩展占位符语法** 如需支持 `<ipv6-addr>`、`<mac>`, 仅需在 `conv_tokens()` 增加对特殊标记的识别与正则模板。  
2. **可选多层嵌套** 目前 `[ ... {A|B} ]` 支持一层可选段；若未来出现更复杂结构，可考虑引入微型语法解析器 (e.g. Lark)。  
3. **CI 集成** 在 GitHub Actions 中运行 `python transf.py … --syntax-file`，将 `syntax.txt` 作为 diff 基线，自动提醒表格变更导致的模板漂移。  
4. **模板分组** 可按功能模块（端口、系统、链路保护…）写入子目录，需调整 `templates-dir` 与 `safe_name` 逻辑。  
5. **逆向验证** 结合 `cmd_parser.py`，用真实设备导出的批量 CLI 执行回放，统计未匹配行，反向完善 Excel。

---

## 版本历史
| 版本 | 日期 | 亮点 |
|------|------|------|
| v0.5 | 2025‑06‑22 | **斜杠动词拆分**；模板总数 287。 |
| v0.4 | 2025‑06‑22 | 文件名净化，Win 路径兼容。 |
| v0.3 | 2025‑06‑20 | 支持省略号 `...`、去除单元格 CR/LF。 |
| v0.2 | 2025‑06‑20 | 修复 `\s` 转义警告，可选段 `[ ]` 解析。 |
| v0.1 | 2025‑06‑18 | 初版，可生成基础模板。 |

---

> **维护者提醒**：每次表格有调整后，请务必重新运行 `transf.py` 并提交 `syntax.txt` diff，以确保模板与文档同步。

